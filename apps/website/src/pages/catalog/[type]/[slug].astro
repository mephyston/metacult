---
import Layout from '../../../layouts/Layout.astro';
import { Button } from '@metacult/shared-ui'; // Assuming we have Button exported
// Note: We might need to import specific UI components from shared-ui or use primitives
import { MoveLeft, Star, Calendar, Clock, Monitor } from 'lucide-vue-next';

export const prerender = false;

const { slug, type } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

// Fetch Media Details
let media = null;
let error = null;

try {
  // TODO: Use env var for API URL
  const baseUrl = 'http://localhost:3000'; 
  // API supports both ID and Slug
  const res = await fetch(`${baseUrl}/api/media/${slug}`);
  
  if (!res.ok) {
    if (res.status === 404) {
      return Astro.redirect('/404');
    }
    throw new Error(`API Error: ${res.status}`);
  }
  
  media = await res.json();
  
  // Optional: Validate URL type matches media type
  // const urlType = type?.toLowerCase();
  // const mediaType = media.type.toLowerCase();
  // if (urlType !== mediaType && urlType !== 'all') {
  //    // Canonical redirect could happen here
  // }
  
} catch (e) {
  console.error('Failed to fetch media:', e);
  error = e;
}

const title = media ? `${media.title} - MetaCult` : 'Media Not Found';
const description = media?.description?.slice(0, 160) || 'Découvrez ce média sur MetaCult.';
---

<Layout title={title} description={description}>
  <div class="container py-10 max-w-5xl mx-auto">
    <!-- Back Button -->
    <div class="mb-6">
      <a href="/" class="inline-flex items-center text-sm text-muted-foreground hover:text-foreground transition-colors">
        <MoveLeft class="mr-2 h-4 w-4" />
        Retour à l'accueil
      </a>
    </div>

    {error && (
      <div class="rounded-lg border border-destructive/50 p-4 text-destructive">
        Une erreur est survenue lors du chargement du média.
      </div>
    )}

    {media && (
      <div class="grid grid-cols-1 md:grid-cols-[300px_1fr] gap-8">
        <!-- Poster Column -->
        <div class="flex flex-col gap-4">
            <div class="relative aspect-[2/3] overflow-hidden rounded-lg border bg-muted shadow-sm">
                {media.posterUrl ? (
                    <img 
                        src={media.posterUrl} 
                        alt={media.title}
                        class="h-full w-full object-cover transition-transform hover:scale-105"
                        transition:name={`poster-${media.id}`}
                    />
                ) : (
                    <div class="flex h-full items-center justify-center bg-muted text-muted-foreground">
                        No Poster
                    </div>
                )}
            </div>
            
            <!-- Quick Actions (Placeholder) -->
            <div class="grid grid-cols-1 gap-2">
                 <!-- TODO: Add Interactive Buttons (Rate, Add to List) -->
            </div>
        </div>

        <!-- Info Column -->
        <div class="flex flex-col gap-6">
            <div>
                <h1 class="text-4xl font-bold tracking-tight lg:text-5xl mb-2">{media.title}</h1>
                
                <div class="flex flex-wrap gap-4 text-sm text-muted-foreground items-center">
                    {media.releaseYear && (
                        <div class="flex items-center gap-1">
                            <Calendar class="h-4 w-4" />
                            <span>{media.releaseYear}</span>
                        </div>
                    )}
                    {media.rating && (
                         <div class="flex items-center gap-1 text-yellow-500">
                            <Star class="h-4 w-4 fill-current" />
                            <span>{media.rating}/10</span>
                        </div>
                    )}
                    <div class="px-2.5 py-0.5 rounded-full bg-secondary text-secondary-foreground text-xs font-semibold uppercase tracking-wider">
                        {media.type}
                    </div>
                </div>
            </div>

            <!-- Description -->
            {media.description && (
                <div class="prose prose-zinc dark:prose-invert max-w-none">
                    <h3 class="text-xl font-semibold mb-2">Synopsis</h3>
                    <p class="leading-relaxed text-muted-foreground">{media.description}</p>
                </div>
            )}

            <!-- Metadata Grid -->
            <div class="grid grid-cols-2 gap-4 border-t pt-6 mt-2">
                {media.metadata?.director && (
                    <div>
                        <span class="block text-xs font-medium text-muted-foreground uppercase">Réalisateur</span>
                        <span class="text-sm">{media.metadata.director}</span>
                    </div>
                )}
                 {media.metadata?.developer && (
                    <div>
                        <span class="block text-xs font-medium text-muted-foreground uppercase">Studio</span>
                        <span class="text-sm">{media.metadata.developer}</span>
                    </div>
                )}
                 {media.metadata?.author && (
                    <div>
                        <span class="block text-xs font-medium text-muted-foreground uppercase">Auteur</span>
                        <span class="text-sm">{media.metadata.author}</span>
                    </div>
                )}
                 {media.metadata?.platform && (
                    <div>
                         <span class="block text-xs font-medium text-muted-foreground uppercase">Plateformes</span>
                         <span class="text-sm">{Array.isArray(media.metadata.platform) ? media.metadata.platform.join(', ') : media.metadata.platform}</span>
                    </div>
                )}
            </div>
            
        </div>
      </div>
    )}
  </div>
</Layout>
