---
import Layout from '../layouts/Layout.astro';
import { Hero } from '@metacult/shared-ui';
import { getImage } from 'astro:assets';
import heroImage from '../assets/hero.jpg';
import { getApiUrl } from '../utils/get-api-url';

// Basic Server-Side Data Fetching
let recentMedias = [];
try {
	const requestId = Astro.locals.requestId;
	const apiUrl = getApiUrl();

	console.log('üîó [Website] Resolved API URL:', apiUrl);

	// üîç DEBUG: Verify Sharp Availability in Runtime
	try {
		console.log('üîç [Website DEBUG] Attempting to require sharp...');
		const sharp = await import('sharp');
		console.log('‚úÖ [Website DEBUG] Sharp loaded successfully');
		console.log('‚úÖ [Website DEBUG] Sharp version:', sharp.default?.versions || sharp.versions);
	} catch (err) {
		console.error('‚ùå [Website DEBUG] FAILED to load sharp:', err);
		console.error('‚ùå [Website DEBUG] Stack:', err.stack);
	}

	const res = await fetch(`${apiUrl}/api/media/recent`, {
		headers: {
			'x-request-id': requestId || crypto.randomUUID(),
		},
	});
	if (res.ok) {
		recentMedias = await res.json();
	} else {
		console.error('Failed to fetch recent media:', res.statusText);
	}
} catch (e) {
	console.error('Error fetching recent media:', e);
}

// Hero Content (Moved to variables to ensure clean strings)
const heroBadge = 'Metacult';
const heroHeading = 'Le Radar Social pour votre Culture.';
const heroDescription =
	'D√©couvrez, suivez et partagez vos films, jeux et s√©ries pr√©f√©r√©s avec votre squad. Une seule app pour toute votre culture.';
const heroCtaText = 'Cr√©er un compte';
const heroSecondaryCtaText = 'Se connecter';
const heroImageSizes =
	'(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1920px';

const heroBg = await getImage({
	src: heroImage,
	width: 1920,
	height: 1080,
	format: 'avif',
	quality: 85,
});
---

<Layout title="MetaCult - Le Radar Social">
	<!-- HERO SECTION -->
	<Hero
		client:idle
		badge={heroBadge}
		heading={heroHeading}
		description={heroDescription}
		ctaText={heroCtaText}
		ctaLink="/auth/register"
		secondaryCtaText={heroSecondaryCtaText}
		secondaryCtaLink="/auth/login"
		image={heroBg.src}
		imageSizes={heroImageSizes}
		fetchpriority="high"
		recentMedias={recentMedias}
	/>
</Layout>
