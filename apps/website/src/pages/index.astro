---
import Layout from '../layouts/Layout.astro';
import { Hero } from '@metacult/shared-ui';
import { getImage } from 'astro:assets';
import heroImage from '../assets/hero.jpg';

// Basic Server-Side Data Fetching
let recentMedias = [];
try {
	const requestId = Astro.locals.requestId;
	// Prioritize Runtime Env Vars (process.env) for SSR.
	// This prevents "undefined" being baked in at build time if variables are missing during docker build.
	let rawApiUrl =
		process.env.API_URL ||
		process.env.PUBLIC_API_URL ||
		import.meta.env.PUBLIC_API_URL;
	let apiUrl = rawApiUrl;
	if (rawApiUrl && !rawApiUrl.startsWith('http')) {
		// Fallback: Assume HTTPS for public or HTTP for internal if uncertain,
		// but safely default to https for security unless it looks like an internal hostname.
		apiUrl = `https://${rawApiUrl}`;
	}

	const res = await fetch(`${apiUrl}/api/media/recent`, {
		headers: {
			'x-request-id': requestId || crypto.randomUUID(),
		},
	});
	if (res.ok) {
		recentMedias = await res.json();
	} else {
		console.error('Failed to fetch recent media:', res.statusText);
	}
} catch (e) {
	console.error('Error fetching recent media:', e);
}

// Hero Content (Moved to variables to ensure clean strings)
const heroBadge = 'Metacult';
const heroHeading = 'Le Radar Social pour votre Culture.';
const heroDescription =
	'Découvrez, suivez et partagez vos films, jeux et séries préférés avec votre squad. Une seule app pour toute votre culture.';
const heroCtaText = 'Créer un compte';
const heroSecondaryCtaText = 'Se connecter';
const heroImageSizes =
	'(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1920px';

const heroBg = await getImage({
	src: heroImage,
	width: 1920,
	height: 1080,
	format: 'avif',
	quality: 85,
});
---

<Layout title="MetaCult - Le Radar Social">
	<!-- HERO SECTION -->
	<Hero
		client:idle
		badge={heroBadge}
		heading={heroHeading}
		description={heroDescription}
		ctaText={heroCtaText}
		ctaLink="/auth/register"
		secondaryCtaText={heroSecondaryCtaText}
		secondaryCtaLink="/auth/login"
		image={heroBg.src}
		imageSizes={heroImageSizes}
		fetchpriority="high"
		recentMedias={recentMedias}
	/>
</Layout>
