---
import Layout from '../layouts/Layout.astro';
import { Hero, SwipeDeck } from '@metacult/shared-ui';
import { getImage } from 'astro:assets';
import heroImage from '../assets/hero.jpg';

// Force Static Site Generation for this page
// This ensures images are optimized at build time, avoiding runtime 500 errors in Docker.
export const prerender = true;

// Hero Content (Moved to variables to ensure clean strings)
const heroBadge = 'Metacult';
const heroHeading = 'Le Radar Social pour votre Culture.';
const heroDescription =
	'Découvrez, suivez et partagez vos films, jeux et séries préférés avec votre squad. Une seule app pour toute votre culture.';
const heroCtaText = 'Créer un compte';
const heroSecondaryCtaText = 'Se connecter';
const heroImageSizes =
	'(max-width: 768px) 100vw, (max-width: 1200px) 80vw, 1920px';

// Demo Games for SwipeDeck
const demoGames = [
	{
		id: '11111111-1111-1111-1111-111111111111', // UUID valid required by backend
		title: 'Elden Ring',
		image: 'https://images.igdb.com/igdb/image/upload/t_cover_big/co4jni.jpg',
	},
	{
		id: '22222222-2222-2222-2222-222222222222',
		title: 'The Legend of Zelda: Tears of the Kingdom',
		image: 'https://images.igdb.com/igdb/image/upload/t_cover_big/co5vmg.jpg',
	},
	{
		id: '33333333-3333-3333-3333-333333333333',
		title: 'Hollow Knight',
		image: 'https://images.igdb.com/igdb/image/upload/t_cover_big/co2ash.jpg',
	},
	{
		id: '44444444-4444-4444-4444-444444444444',
		title: 'Hades',
		image: 'https://images.igdb.com/igdb/image/upload/t_cover_big/co2i0f.jpg',
	},
	{
		id: '55555555-5555-5555-5555-555555555555',
		title: 'Cyberpunk 2077',
		image: 'https://images.igdb.com/igdb/image/upload/t_cover_big/co49x5.jpg',
	},
];

// Fetch Real Media from Discovery API
let interactions: any[] = [];
try {
	const apiUrl = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000';
	// Utilisation de fetch normal (Astro build context)
	const response = await fetch(`${apiUrl}/api/discovery/feed`);
	if (response.ok) {
		const data = await response.json();
		if (Array.isArray(data)) {
			// Mapping MediaReadDto -> SwipeItem
			interactions = data.slice(0, 5).map((item: any) => ({
				id: item.data?.id || item.id,
				title: item.data?.title || item.title,
				image:
					item.data?.coverUrl ||
					item.coverUrl ||
					'https://images.igdb.com/igdb/image/upload/t_cover_big/co4jni.jpg', // Fallback
				type: item.type,
			}));
		}
	} else {
		console.error('Failed to fetch discovery feed:', response.status);
	}
} catch (e) {
	console.error('Error loading discovery feed:', e);
}

// Fallback to demo if API failed or empty
if (interactions.length === 0) {
	interactions = demoGames;
}

// Build-time Image Optimization
const heroBg = await getImage({
	src: heroImage,
	width: 1920,
	height: 1080,
	format: 'avif',
	quality: 85,
});

// App URL for redirection (Register/Login)
const appUrl = import.meta.env.PUBLIC_WEBAPP_URL || 'http://localhost:4201';
---

<Layout title="MetaCult - Le Radar Social">
	<!-- HERO SECTION -->
	<!-- @ts-expect-error - Astro client directives are not part of component props -->
	<Hero
		client:load
		badge={heroBadge}
		heading={heroHeading}
		description={heroDescription}
		ctaText={heroCtaText}
		ctaLink={`${appUrl}/register`}
		secondaryCtaText={heroSecondaryCtaText}
		secondaryCtaLink={`${appUrl}/login`}
		image={heroBg.src}
		imageSizes={heroImageSizes}
		fetchpriority="high"
		recentMedias={[]}
	>
		<!-- Slot pour remplacer la carte statique par SwipeDeck -->
		<div slot="interactive-card" class="relative w-full max-w-sm mx-auto">
			<!-- @ts-expect-error - Astro client directives are not part of component props -->
			<SwipeDeck
				client:visible
				items={interactions}
				guestMode={true}
				signupUrl={`${appUrl}/register`}
				loginUrl={`${appUrl}/login`}
			/>
		</div>
	</Hero>
</Layout>
