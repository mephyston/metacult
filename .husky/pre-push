#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ›¡ï¸  Starting Quality Gate Audit..."

# 1. Run Tests with Coverage
echo "ğŸ“¦ Running Tests with Coverage..."
if ! bun run test:coverage; then
  echo "âŒ Tests or Coverage failed. Push aborted."
  exit 1
fi

# 2. Run Qodana Analysis (Strict Mode)
echo "ğŸ•µï¸  Running Qodana Analysis..."
if ! bun x @jetbrains/qodana-cli scan --lcov coverage/lcov.info --results-dir ./qodana-results; then
  echo "âŒ Qodana found issues. Push aborted."
  echo "ğŸ’¡ Run 'bun run qodana:local' to view the full report in your browser."
  exit 1
fi

echo "âœ… Quality Gate Passed. Pushing..."
