#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üõ°Ô∏è  Starting Quality Gate Audit..."

# 1. Run Tests with Coverage
echo "üì¶ Running Tests with Coverage..."
if ! bun run test:coverage; then
  echo "‚ùå Tests or Coverage failed. Push aborted."
  exit 1
fi

# 2. Prepare Coverage for Qodana
echo "üìä Preparing coverage report..."
mkdir -p .qodana/code-coverage
cp coverage/lcov.info .qodana/code-coverage/

# 3. Run Qodana Analysis
echo "üïµÔ∏è  Running Qodana Analysis..."

# Function to run Qodana via Docker
run_qodana_docker() {
  echo "üê≥ Qodana CLI not found. Falling back to Docker..."
  docker run --rm \
    -v "$(pwd)":/data/project \
    -e QODANA_TOKEN=$QODANA_TOKEN \
    jetbrains/qodana-js:2024.3-eap \
    scan --results-dir ./qodana-results
}

if command -v qodana &> /dev/null; then
  # Use native CLI if available
  if ! qodana scan --results-dir ./qodana-results; then
      echo "‚ùå Qodana found issues (CLI). Push aborted."
      exit 1
  fi
elif command -v docker &> /dev/null; then
  # Use Docker if CLI is missing
  if ! run_qodana_docker; then
      echo "‚ùå Qodana found issues (Docker). Push aborted."
      exit 1
  fi
else
  echo "‚ö†Ô∏è  Qodana CLI and Docker not found. Skipping Qodana analysis."
  echo "‚ÑπÔ∏è  To enable quality checks, install Qodana CLI: brew install jetbrains/utils/qodana"
fi

echo "‚úÖ Quality Gate Passed. Pushing..."
