name: CI/CD Pipeline

on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      releaseType:
        description: 'Type of release'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - prerelease
      preid:
        description: 'Prerelease Identifier (only for prerelease)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - alpha
          - beta
          - rc

permissions:
  contents: write
  packages: write
  actions: read

env:
  NX_HEAD: HEAD
  NX_BASE: HEAD~1

jobs:
  # ------------------------------------------------------------------
  # JOB 1 (Part A): STAGING CHECKS
  # Trigger: Push on develop
  # Goal: Lint & Test only affected projects
  # ------------------------------------------------------------------
  staging-checks:
    name: üß™ Staging Checks
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Playwright Browsers
        uses: actions/cache@v3
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('**/package-lock.json', '**/yarn.lock', '**/pnpm-lock.yaml', '**/bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      # - name: Install Playwright Browsers
      #   run: bunx playwright install --with-deps

      - name: Lint Affected
        run: bun run nx affected -t lint --parallel=3

      - name: Test Affected
        run: bun run nx affected -t test --parallel=3 --exclude=e2e

  # ------------------------------------------------------------------
  # JOB 1 (Part B): STAGING BUILD & DEPLOY
  # Trigger: Push on develop (follows checks)
  # Goal: Build -> Push (staging+sha) -> Deploy Railway Staging
  # ------------------------------------------------------------------
  staging-deploy:
    name: üöÄ Staging Deploy (${{ matrix.app }})
    needs: staging-checks
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        app: [api, webapp, website, worker]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lowercase Repo Owner
        id: get-owner
        run: echo "owner=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/${{ matrix.app }}/Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/${{ steps.get-owner.outputs.owner }}/metacult-${{ matrix.app }}:staging
            ghcr.io/${{ steps.get-owner.outputs.owner }}/metacult-${{ matrix.app }}:sha-${{ github.sha }}
          build-args: |
            GIT_COMMIT_SHA=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway Staging
        # Using 'redeploy' to trigger a pull of the new image from GHCR
        # Service name is just the app name (lowercase)
        # Note: Environment is determined by RAILWAY_TOKEN (staging token = staging env)
        run: railway redeploy --service ${{ matrix.app }} --yes
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_STAGING }}

  # ------------------------------------------------------------------
  # JOB 2: PROD RELEASE & DEPLOY
  # Trigger: Manual workflow_dispatch
  # Goal: Version (Nx) -> Promote Image (Staging->Prod) -> Deploy Railway Prod
  # ------------------------------------------------------------------
  prod-release:
    name: üöÄ Prod Release & Deploy
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate Release Name
        id: release-name
        run: |
          ADJECTIVES=("Cosmic" "Shiny" "Epic" "Fast" "Silent" "Brave" "Witty" "Mighty" "Clever" "Wild")
          ANIMALS=("Bear" "Wolf" "Eagle" "Tiger" "Shark" "Fox" "Lion" "Hawk" "Owl" "Panda")
          RANDOM_ADJ=${ADJECTIVES[$RANDOM % ${#ADJECTIVES[@]}]}
          RANDOM_ANI=${ANIMALS[$RANDOM % ${#ANIMALS[@]}]}
          RELEASE_NAME="$RANDOM_ADJ $RANDOM_ANI"
          echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_OUTPUT
          echo "Generated Release Name: $RELEASE_NAME"

      - name: Nx Release (Version & Changelog)
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HUSKY: 0
        run: |
          if [ "${{ inputs.preid }}" == "none" ]; then
             bun run nx release ${{ inputs.releaseType }} --skip-publish
          else
             bun run nx release ${{ inputs.releaseType }} --preid=${{ inputs.preid }} --skip-publish
          fi

      - name: Get Released Version
        id: get-version
        run: echo "VERSION=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT

      - name: Lowercase Repo Owner
        id: get-owner
        run: echo "owner=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Initialize Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Promote Images & Deploy Prod
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN_PRODUCTION }}
        run: |
          VERSION=${{ steps.get-version.outputs.VERSION }}
          OWNER=${{ steps.get-owner.outputs.owner }}
          APPS=("api" "webapp" "website" "worker")

          echo "üî• Promoting images for version: $VERSION"

          echo "üî• Promoting images for version: $VERSION"

          # 1. PROMOTION PHASE
          # We promote ALL images first. If any fails, the script exits, and no deployments occur.
          for APP in "${APPS[@]}"; do
            SHA_TAG="ghcr.io/$OWNER/metacult-$APP:sha-${{ github.sha }}"
            STAGING_TAG="ghcr.io/$OWNER/metacult-$APP:staging"
            
            SOURCE_IMAGE="$SHA_TAG"
            if ! docker buildx imagetools inspect "$SOURCE_IMAGE" &>/dev/null; then
               echo "‚ö†Ô∏è  Image $SHA_TAG not found. Falling back to $STAGING_TAG"
               SOURCE_IMAGE="$STAGING_TAG"
            fi
            
            TARGET_LATEST="ghcr.io/$OWNER/metacult-$APP:latest"
            TARGET_VERSION="ghcr.io/$OWNER/metacult-$APP:$VERSION"
            
            echo "---------------------------------------------------"
            echo "üì¶ Promoting App: $APP"
            echo "   Source: $SOURCE_IMAGE"
            echo "   Targets: $TARGET_LATEST, $TARGET_VERSION"
            
            docker buildx imagetools create -t $TARGET_LATEST -t $TARGET_VERSION $SOURCE_IMAGE
          done

          echo "‚úÖ All images promoted successfully. Starting deployment..."

          # 2. DEPLOYMENT PHASE
          # Only runs if all promotions succeeded.
          for APP in "${APPS[@]}"; do
            echo "üöÄ Deploying $APP to Production..."
            railway redeploy --service $APP --yes
          done

          echo "‚úÖ All services promoted and deployed to Production!"
