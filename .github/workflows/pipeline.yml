name: CI/CD Pipeline

on:
  push:
    branches:
      - develop
      - main
    paths-ignore:
      - '**/*.md'
      - '.vscode/**'
      - 'CHANGELOG.md'

permissions:
  contents: write
  packages: write
  actions: read

jobs:
  # ------------------------------------------------------------------
  # JOB 1 (Part A): STAGING CHECKS
  # Trigger: Push on develop
  # Goal: Lint & Test only affected projects
  # ------------------------------------------------------------------
  staging-checks:
    name: ðŸ§ª Staging Checks (Lint & Test)
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Lint Affected
        run: bun run nx affected -t lint --base=HEAD~1 --parallel=3

      - name: Test Affected
        run: bun run nx affected -t test --base=HEAD~1 --parallel=3

  # ------------------------------------------------------------------
  # JOB 1 (Part B): STAGING BUILD & DEPLOY
  # Trigger: Push on develop (follows checks)
  # Goal: Build & Push Docker Images -> Deploy to Railway Staging
  # ------------------------------------------------------------------
  staging-build:
    name: ðŸ³ Staging Build & Deploy (${{ matrix.app }})
    needs: staging-checks
    if: github.ref == 'refs/heads/develop'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app: [api, webapp, website]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lowercase Repo Owner
        run: echo "OWNER=${GITHUB_REPOSITORY_OWNER,,}" >>${GITHUB_ENV}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/${{ matrix.app }}/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ env.OWNER }}/metacult-${{ matrix.app }}:staging
            ghcr.io/${{ env.OWNER }}/metacult-${{ matrix.app }}:sha-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # RAILWAY DEPLOYMENT (Staging)
      # Assumes Railway Service Name matches matrix.app (api, webapp, website)
      # Requires RAILWAY_TOKEN in GitHub Secrets
      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway Staging
        # Using 'redeploy' to trigger a pull of the new image
        run: railway redeploy --service ${{ matrix.app }} --environment staging
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  # ------------------------------------------------------------------
  # JOB 2: PROD RELEASE & DEPLOY
  # Trigger: Push on main
  # Goal: Versioning (Nx) + Promotion (Docker ImageTools) -> Deploy to Railway Prod
  # ------------------------------------------------------------------
  prod-release:
    name: ðŸš€ Production Release & Deploy
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Nx Release (Version & Changelog)
        id: release
        run: bun run nx release --skip-publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Released Version
        id: get-version
        run: echo "VERSION=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT

      - name: Lowercase Repo Owner
        run: echo "OWNER=${GITHUB_REPOSITORY_OWNER,,}" >>${GITHUB_ENV}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Initialize Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Promote Images & Deploy to Prod
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          VERSION=${{ steps.get-version.outputs.VERSION }}
          APPS=("api" "webapp" "website")

          echo "ðŸ”¥ Promoting images for version: $VERSION"

          for APP in "${APPS[@]}"; do
            SOURCE_IMAGE="ghcr.io/${{ env.OWNER }}/metacult-$APP:staging"
            TARGET_LATEST="ghcr.io/${{ env.OWNER }}/metacult-$APP:latest"
            TARGET_VERSION="ghcr.io/${{ env.OWNER }}/metacult-$APP:$VERSION"
            
            echo "---------------------------------------------------"
            echo "ðŸ“¦ App: $APP"
            echo "   Promoting: $SOURCE_IMAGE -> $TARGET_LATEST"
            docker buildx imagetools create -t $TARGET_LATEST -t $TARGET_VERSION $SOURCE_IMAGE
            
            echo "   ðŸš€ Deploying to Railway Production..."
            railway redeploy --service $APP --environment production
          done

          echo "âœ… All services promoted and deployed to Production!"
